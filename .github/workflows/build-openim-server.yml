name: Build OpenIM Server on Anolis OS 8.10

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      openim_server_tag:
        description: 'OpenIM Serverç‰ˆæœ¬æ ‡ç­¾ (å¦‚: v3.8.0)'
        required: true
        default: 'v3.8.0'
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºé•œåƒ'
        type: boolean
        default: false
  
  # å®šæ—¶æ£€æŸ¥æ›´æ–° (æ¯å¤© UTC 2:00)
  schedule:
    - cron: '0 2 * * *'
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'dockerfiles/anolis/Dockerfile.openim-server'
      - '.github/workflows/build-openim-server.yml'

env:
  # é•œåƒä»“åº“é…ç½®
  REGISTRY_ALIYUN: registry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAMESPACE: aspirin2019  # å…¬å…±é•œåƒå‘½åç©ºé—´
  
  # OpenIMå®˜æ–¹ä»“åº“
  OPENIM_SERVER_REPO: openimsdk/open-im-server

jobs:
  check-server-updates:
    runs-on: ubuntu-latest
    outputs:
      server_version: ${{ steps.check.outputs.server_version }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥OpenIM Serverç‰ˆæœ¬æ›´æ–°
        id: check
        run: |
          # è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          SERVER_LATEST=$(curl -s https://api.github.com/repos/${OPENIM_SERVER_REPO}/releases/latest | jq -r .tag_name)
          
          # æ£€æŸ¥è·å–çš„ç‰ˆæœ¬æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæ— æ•ˆåˆ™ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          if [[ "$SERVER_LATEST" == "null" || -z "$SERVER_LATEST" ]]; then
            SERVER_LATEST="v3.8.0"
          fi
          
          echo "server_version=${SERVER_LATEST}" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
          SHOULD_BUILD=false
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºæ‰‹åŠ¨è§¦å‘æˆ–å¼ºåˆ¶é‡å»º
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHOULD_BUILD=true
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºpushè§¦å‘
          if [[ "${{ github.event_name }}" == "push" ]]; then
            SHOULD_BUILD=true
          fi
          
          # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶
          if [[ ! -f server-versions.txt ]]; then
            echo "server=" > server-versions.txt
            SHOULD_BUILD=true
          fi
          
          # æ¯”è¾ƒç‰ˆæœ¬
          PREV_SERVER=$(grep "server=" server-versions.txt | cut -d'=' -f2)
          
          if [[ "${SERVER_LATEST}" != "${PREV_SERVER}" ]]; then
            SHOULD_BUILD=true
          fi
          
          echo "should_build=${SHOULD_BUILD}" >> $GITHUB_OUTPUT
          
          echo "ğŸ” æ£€æµ‹åˆ°çš„ç‰ˆæœ¬:"
          echo "OpenIM Server: ${SERVER_LATEST} (ä¹‹å‰: ${PREV_SERVER})"
          echo "æ˜¯å¦éœ€è¦æ„å»º: ${SHOULD_BUILD}"

  build-server:
    needs: check-server-updates
    if: needs.check-server-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_ALIYUN }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: ä¸‹è½½OpenIM Serveræºç 
        run: |
          # ç¡®å®šè¦ä½¿ç”¨çš„ç‰ˆæœ¬
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SERVER_VERSION="${{ github.event.inputs.openim_server_tag }}"
          else
            SERVER_VERSION="${{ needs.check-server-updates.outputs.server_version }}"
          fi
          
          echo "ğŸš€ ä½¿ç”¨ç‰ˆæœ¬: ${SERVER_VERSION}"
          
          # æ£€æŸ¥ç‰ˆæœ¬æ ¼å¼
          if [[ ! "$SERVER_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬æ ¼å¼ä¸æ­£ç¡®: ${SERVER_VERSION}"
            echo "è¯·ä½¿ç”¨ç±»ä¼¼ v3.8.0 çš„æ ¼å¼"
            exit 1
          fi
          
          # å°è¯•å…‹éš†æŒ‡å®šç‰ˆæœ¬
          if ! git clone --depth 1 --branch ${SERVER_VERSION} https://github.com/${OPENIM_SERVER_REPO}.git openim-server; then
            echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ°ç‰ˆæœ¬ ${SERVER_VERSION}"
            echo "æ­£åœ¨è·å–å¯ç”¨çš„æ ‡ç­¾..."
            git ls-remote --tags https://github.com/${OPENIM_SERVER_REPO}.git | head -10
            exit 1
          fi
          
          cp dockerfiles/anolis/Dockerfile.openim-server openim-server/Dockerfile

      - name: æ„å»ºå¹¶æ¨é€OpenIM Serveré•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./openim-server
          file: ./openim-server/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY_ALIYUN }}/${{ env.ALIYUN_NAMESPACE }}/openim-server:${{ needs.check-server-updates.outputs.server_version }}-anolis
            ${{ env.REGISTRY_ALIYUN }}/${{ env.ALIYUN_NAMESPACE }}/openim-server:latest-anolis
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=OpenIM Server on Anolis OS 8.10
            org.opencontainers.image.description=OpenIM Server built on Anolis OS 8.10
            org.opencontainers.image.version=${{ needs.check-server-updates.outputs.server_version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}

  update-server-versions:
    needs: [check-server-updates, build-server]
    if: always() && needs.check-server-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ›´æ–°Serverç‰ˆæœ¬æ–‡ä»¶
        run: |
          echo "server=${{ needs.check-server-updates.outputs.server_version }}" > server-versions.txt

      - name: æ›´æ–°ç¯å¢ƒé…ç½®æ–‡ä»¶
        run: |
          # ä½¿æ›´æ–°è„šæœ¬å¯æ‰§è¡Œ
          chmod +x scripts/update-env.sh
          
          # æ›´æ–°Serverç‰ˆæœ¬
          ./scripts/update-env.sh update-var OPENIM_SERVER_VERSION "${{ needs.check-server-updates.outputs.server_version }}-anolis"
          
          echo "âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å·²æ›´æ–°"

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add server-versions.txt .env
          git commit -m "ğŸš€ æ›´æ–°OpenIM Serverç‰ˆæœ¬åˆ° ${{ needs.check-server-updates.outputs.server_version }}" || exit 0
          git push

      - name: æ„å»ºæ€»ç»“
        run: |
          echo "ğŸ‰ OpenIM Server é•œåƒæ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ æ„å»ºçš„é•œåƒ:"
          echo "  ğŸš€ Server: ${{ env.REGISTRY_ALIYUN }}/${{ env.ALIYUN_NAMESPACE }}/openim-server:${{ needs.check-server-updates.outputs.server_version }}-anolis"
          echo ""
          echo "ğŸ’¡ Chaté•œåƒè¯·ä½¿ç”¨ç§æœ‰æ„å»ºå·¥ä½œæµå•ç‹¬æ„å»º" 