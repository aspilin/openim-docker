name: Build Base Components on Anolis OS 8.10

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰åŸºç¡€ç»„ä»¶'
        type: boolean
        default: false
      components:
        description: 'é€‰æ‹©è¦æ„å»ºçš„ç»„ä»¶ (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: mongodb,redis)'
        required: false
        default: 'mongodb,redis'
      test_build:
        description: 'ä»…æµ‹è¯•æ„å»ºï¼Œä¸æ¨é€é•œåƒ'
        type: boolean
        default: false
  
  # å®šæ—¶æ£€æŸ¥æ›´æ–° (æ¯å‘¨ä¸€ UTC 3:00)
  schedule:
    - cron: '0 3 * * 1'
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'dockerfiles/anolis/Dockerfile.mongodb'
      - 'dockerfiles/anolis/Dockerfile.redis'
      - '.github/workflows/build-base-components.yml'

env:
  # é•œåƒä»“åº“é…ç½®
  REGISTRY_ALIYUN: registry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAMESPACE: aspirin2019  # å…¬å…±é•œåƒå‘½åç©ºé—´
  
  # OpenIMå®˜æ–¹ä»“åº“
  OPENIM_SERVER_REPO: openimsdk/open-im-server

jobs:
  check-base-component-updates:
    runs-on: ubuntu-latest
    outputs:
      mongodb_version: ${{ steps.check.outputs.mongodb_version }}
      redis_version: ${{ steps.check.outputs.redis_version }}
      should_build: ${{ steps.check.outputs.should_build }}
      components_to_build: ${{ steps.check.outputs.components_to_build }}
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½å®˜æ–¹docker-compose.ymlæ–‡ä»¶
        run: |
          echo "ğŸ“¥ ä¸‹è½½å®˜æ–¹Serverä»“åº“çš„docker-compose.yml..."
          curl -s https://raw.githubusercontent.com/${OPENIM_SERVER_REPO}/main/docker-compose.yml -o official-docker-compose.yml
          
          if [[ ! -f official-docker-compose.yml ]]; then
            echo "âŒ æ— æ³•ä¸‹è½½å®˜æ–¹docker-compose.ymlæ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æˆåŠŸä¸‹è½½å®˜æ–¹docker-compose.yml"

      - name: æ£€æŸ¥åŸºç¡€ç»„ä»¶ç‰ˆæœ¬æ›´æ–°
        id: check
        run: |
          # ä»å®˜æ–¹docker-compose.ymlä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
          MONGODB_VERSION=$(grep -A 10 "mongo:" official-docker-compose.yml | grep "image:" | head -1 | sed -E 's/.*mongo:([0-9]+\.[0-9]+(\.[0-9]+)?).*/\1/')
          REDIS_VERSION=$(grep -A 10 "redis:" official-docker-compose.yml | grep "image:" | head -1 | sed -E 's/.*redis:([0-9]+\.[0-9]+(\.[0-9]+)?).*/\1/')
          
          # å¦‚æœæå–å¤±è´¥æˆ–è€…ç»“æœä¸æ­£ç¡®ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          if [[ -z "$MONGODB_VERSION" || ! "$MONGODB_VERSION" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            MONGODB_VERSION="7.0.4"
            echo "âš ï¸ MongoDBç‰ˆæœ¬æå–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: ${MONGODB_VERSION}"
          fi
          if [[ -z "$REDIS_VERSION" || ! "$REDIS_VERSION" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            REDIS_VERSION="7.2.3"
            echo "âš ï¸ Redisç‰ˆæœ¬æå–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: ${REDIS_VERSION}"
          fi
          
          echo "mongodb_version=${MONGODB_VERSION}" >> $GITHUB_OUTPUT
          echo "redis_version=${REDIS_VERSION}" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
          SHOULD_BUILD=false
          COMPONENTS_TO_BUILD=""
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºæ‰‹åŠ¨è§¦å‘æˆ–å¼ºåˆ¶é‡å»º
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHOULD_BUILD=true
            if [[ -n "${{ github.event.inputs.components }}" ]]; then
              COMPONENTS_TO_BUILD="${{ github.event.inputs.components }}"
            else
              COMPONENTS_TO_BUILD="mongodb,redis"
            fi
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºpushè§¦å‘
          if [[ "${{ github.event_name }}" == "push" ]]; then
            SHOULD_BUILD=true
            COMPONENTS_TO_BUILD="mongodb,redis"
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºå®šæ—¶è§¦å‘
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            SHOULD_BUILD=true
            COMPONENTS_TO_BUILD="mongodb,redis"
          fi
          
          # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶
          if [[ ! -f base-versions.txt ]]; then
            echo "mongodb=" > base-versions.txt
            echo "redis=" >> base-versions.txt
            SHOULD_BUILD=true
            COMPONENTS_TO_BUILD="mongodb,redis"
          fi
          
          # æ¯”è¾ƒç‰ˆæœ¬
          if [[ -f base-versions.txt ]]; then
            PREV_MONGODB=$(grep "mongodb=" base-versions.txt | cut -d'=' -f2)
            PREV_REDIS=$(grep "redis=" base-versions.txt | cut -d'=' -f2)
            
            if [[ "${MONGODB_VERSION}" != "${PREV_MONGODB}" ]]; then
              SHOULD_BUILD=true
              if [[ -z "$COMPONENTS_TO_BUILD" ]]; then
                COMPONENTS_TO_BUILD="mongodb"
              elif [[ "$COMPONENTS_TO_BUILD" != *"mongodb"* ]]; then
                COMPONENTS_TO_BUILD="${COMPONENTS_TO_BUILD},mongodb"
              fi
            fi
            
            if [[ "${REDIS_VERSION}" != "${PREV_REDIS}" ]]; then
              SHOULD_BUILD=true
              if [[ -z "$COMPONENTS_TO_BUILD" ]]; then
                COMPONENTS_TO_BUILD="redis"
              elif [[ "$COMPONENTS_TO_BUILD" != *"redis"* ]]; then
                COMPONENTS_TO_BUILD="${COMPONENTS_TO_BUILD},redis"
              fi
            fi
          fi
          
          echo "should_build=${SHOULD_BUILD}" >> $GITHUB_OUTPUT
          echo "components_to_build=${COMPONENTS_TO_BUILD}" >> $GITHUB_OUTPUT
          
          echo "ğŸ” æ£€æµ‹åˆ°çš„ç‰ˆæœ¬:"
          echo "MongoDB: ${MONGODB_VERSION} (ä¹‹å‰: ${PREV_MONGODB:-æœªçŸ¥})"
          echo "Redis: ${REDIS_VERSION} (ä¹‹å‰: ${PREV_REDIS:-æœªçŸ¥})"
          echo "æ˜¯å¦éœ€è¦æ„å»º: ${SHOULD_BUILD}"
          echo "éœ€è¦æ„å»ºçš„ç»„ä»¶: ${COMPONENTS_TO_BUILD}"

  build-base-components:
    needs: check-base-component-updates
    if: needs.check-base-component-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [mongodb, redis]
    steps:
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»ºæ­¤ç»„ä»¶
        id: should_build_component
        run: |
          COMPONENTS="${{ needs.check-base-component-updates.outputs.components_to_build }}"
          if [[ "$COMPONENTS" == *"${{ matrix.component }}"* ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âœ… éœ€è¦æ„å»º ${{ matrix.component }}"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ è·³è¿‡æ„å»º ${{ matrix.component }}"
          fi

      - name: Checkoutä»£ç 
        if: steps.should_build_component.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: è®¾ç½®Docker Buildx
        if: steps.should_build_component.outputs.should_build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
        if: steps.should_build_component.outputs.should_build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_ALIYUN }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: æ›´æ–°Dockerfileä¸­çš„ç‰ˆæœ¬
        if: steps.should_build_component.outputs.should_build == 'true'
        run: |
          DOCKERFILE="dockerfiles/anolis/Dockerfile.${{ matrix.component }}"
          
          if [[ "${{ matrix.component }}" == "mongodb" ]]; then
            VERSION="${{ needs.check-base-component-updates.outputs.mongodb_version }}"
            # æ›´æ–°MongoDBç‰ˆæœ¬ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„æ¨¡å¼åŒ¹é…
            sed -i "s/^ENV MONGO_VERSION=[0-9.]*/ENV MONGO_VERSION=${VERSION}/" $DOCKERFILE
            echo "ğŸ“ æ›´æ–°MongoDBç‰ˆæœ¬åˆ° ${VERSION}"
          elif [[ "${{ matrix.component }}" == "redis" ]]; then
            VERSION="${{ needs.check-base-component-updates.outputs.redis_version }}"
            # æ›´æ–°Redisç‰ˆæœ¬ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„æ¨¡å¼åŒ¹é…
            sed -i "s/^ENV REDIS_VERSION=[0-9.]*/ENV REDIS_VERSION=${VERSION}/" $DOCKERFILE
            echo "ğŸ“ æ›´æ–°Redisç‰ˆæœ¬åˆ° ${VERSION}"
          fi
          
          # æ˜¾ç¤ºæ›´æ–°åçš„å‰10è¡Œä»¥ä¾¿è°ƒè¯•
          echo "ğŸ” æ›´æ–°åçš„Dockerfileå‰10è¡Œï¼š"
          head -10 $DOCKERFILE
          
          # éªŒè¯DockerfileåŸºæœ¬è¯­æ³•ï¼ˆæ£€æŸ¥ENVè¡Œï¼‰
          echo "ğŸ” éªŒè¯ENVè¯­æ³•..."
          if grep -E "^ENV .+ \\\\" $DOCKERFILE; then
            echo "âœ… å¤šè¡ŒENVæ ¼å¼æ­£ç¡®"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å¤šè¡ŒENVæ ¼å¼ï¼Œæ£€æŸ¥å•è¡ŒENVï¼š"
            grep "^ENV" $DOCKERFILE || echo "âŒ æœªæ‰¾åˆ°ENVè¡Œ"
          fi

      - name: æ„å»ºå¹¶æ¨é€${{ matrix.component }}é•œåƒ
        if: steps.should_build_component.outputs.should_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./dockerfiles/anolis
          file: ./dockerfiles/anolis/Dockerfile.${{ matrix.component }}
          platforms: linux/amd64
          push: ${{ github.event.inputs.test_build != 'true' }}
          tags: |
            ${{ env.REGISTRY_ALIYUN }}/${{ env.ALIYUN_NAMESPACE }}/${{ matrix.component }}:${{ matrix.component == 'mongodb' && needs.check-base-component-updates.outputs.mongodb_version || needs.check-base-component-updates.outputs.redis_version }}-anolis
            ${{ env.REGISTRY_ALIYUN }}/${{ env.ALIYUN_NAMESPACE }}/${{ matrix.component }}:latest-anolis
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=${{ matrix.component }} on Anolis OS 8.10
            org.opencontainers.image.description=${{ matrix.component }} built on Anolis OS 8.10
            org.opencontainers.image.version=${{ matrix.component == 'mongodb' && needs.check-base-component-updates.outputs.mongodb_version || needs.check-base-component-updates.outputs.redis_version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}

  update-base-versions:
    needs: [check-base-component-updates, build-base-components]
    if: success() && needs.check-base-component-updates.outputs.should_build == 'true' && needs.build-base-components.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ›´æ–°åŸºç¡€ç»„ä»¶ç‰ˆæœ¬æ–‡ä»¶ï¼ˆä»…æ„å»ºæˆåŠŸåï¼‰
        run: |
          echo "âœ… æ„å»ºæˆåŠŸï¼Œæ›´æ–°ç‰ˆæœ¬æ–‡ä»¶..."
          echo "mongodb=${{ needs.check-base-component-updates.outputs.mongodb_version }}" > base-versions.txt
          echo "redis=${{ needs.check-base-component-updates.outputs.redis_version }}" >> base-versions.txt

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add base-versions.txt
          git commit -m "ğŸ”§ æ›´æ–°åŸºç¡€ç»„ä»¶ç‰ˆæœ¬åˆ° mongodb:${{ needs.check-base-component-updates.outputs.mongodb_version }}, redis:${{ needs.check-base-component-updates.outputs.redis_version }}" || exit 0
          git push

      - name: æ„å»ºæ€»ç»“
        run: |
          echo "ğŸ‰ åŸºç¡€ç»„ä»¶é•œåƒæ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ æ„å»ºçš„é•œåƒ:"
          COMPONENTS="${{ needs.check-base-component-updates.outputs.components_to_build }}"
          if [[ "$COMPONENTS" == *"mongodb"* ]]; then
            echo "  ğŸƒ MongoDB: ${{ env.REGISTRY_ALIYUN }}/${{ env.ALIYUN_NAMESPACE }}/mongodb:${{ needs.check-base-component-updates.outputs.mongodb_version }}-anolis"
          fi
          if [[ "$COMPONENTS" == *"redis"* ]]; then
            echo "  ğŸ”´ Redis: ${{ env.REGISTRY_ALIYUN }}/${{ env.ALIYUN_NAMESPACE }}/redis:${{ needs.check-base-component-updates.outputs.redis_version }}-anolis"
          fi
          echo ""
          echo "ğŸ“… ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´: æ¯å‘¨ä¸€ UTC 3:00"
          echo "ğŸ”„ ç›‘æ§æ¥æº: å®˜æ–¹ ${OPENIM_SERVER_REPO} docker-compose.yml" 